# vue 入口

## entry-runtime-with-compiler.js

分析常用的 Runtime + Compiler 构建出来的 Vue.js，它的入口在 `src/platforms/web/entry-runtime-with-compiler.js` ，当我们的代码执行 `import Vue from 'vue'`的时候，就是从这个入口执行代码来初始化 Vue。 在此处首先可以看到引入了 vue，然后重写了 vue 的`$mount`方法，在执行之前，对编译时做了一些判断。然后返回`Vue`对象

```js
/* @flow */

import config from 'core/config';
import { warn, cached } from 'core/util/index';
import { mark, measure } from 'core/util/perf';

import Vue from './runtime/index';
import { query } from './util/index';
import { compileToFunctions } from './compiler/index';
import { shouldDecodeNewlines, shouldDecodeNewlinesForHref } from './util/compat';

const idToTemplate = cached(id => {
  const el = query(id);
  return el && el.innerHTML;
});

const mount = Vue.prototype.$mount;
Vue.prototype.$mount = function (el?: string | Element, hydrating?: boolean): Component {
  el = el && query(el);

  /* istanbul ignore if */
  //.....
  const options = this.$options;
  // resolve template/el and convert to render function
  if (!options.render) {
    //.........
    }
  }
  return mount.call(this, el, hydrating);
};

/**
 * Get outerHTML of elements, taking care
 * of SVG elements in IE as well.
 */
function getOuterHTML(el: Element): string {
  //....
}

Vue.compile = compileToFunctions;

export default Vue;

```

## platforms/web/runtime/index.js

继续找，根据前面代码，找到`src/platforms/web/runtime/index.js`目录，在这里也是一样引入了 Vue，然后对 Vue 做了一些处理，定义了一些静态方法、`__patch__`、`$mount`, 最后也是返回一个`Vue`对象。所以继续找

```js
/* @flow */
import Vue from 'core/index';
import config from 'core/config';
import { extend, noop } from 'shared/util';
import { mountComponent } from 'core/instance/lifecycle';
import { devtools, inBrowser } from 'core/util/index';
import { query, mustUseProp, isReservedTag, isReservedAttr, getTagNamespace, isUnknownElement } from 'web/util/index';

import { patch } from './patch';
import platformDirectives from './directives/index';
import platformComponents from './components/index';

// install platform specific utils
Vue.config.mustUseProp = mustUseProp;
Vue.config.isReservedTag = isReservedTag;
Vue.config.isReservedAttr = isReservedAttr;
Vue.config.getTagNamespace = getTagNamespace;
Vue.config.isUnknownElement = isUnknownElement;

// install platform runtime directives & components
extend(Vue.options.directives, platformDirectives);
extend(Vue.options.components, platformComponents);

// install platform patch function
Vue.prototype.__patch__ = inBrowser ? patch : noop;

// public mount method
Vue.prototype.$mount = function (el?: string | Element, hydrating?: boolean): Component {
  el = el && inBrowser ? query(el) : undefined;
  return mountComponent(this, el, hydrating);
};
// devtools global hook
/* istanbul ignore next */
if (inBrowser) {
  //...
}

export default Vue;
```

## src/core/index

这里基本还是和之前的操作一个意思，`initGlobalAPI`初始化`Vue` 的公共方法，然后返回 Vue。
`initGlobalAPI` 是 global-api/index 文件，里面给 Vue 挂载了一些公共方法, 比如不被推荐使用的 `Vue.util`。

```js
Vue.util = {
  warn,
  extend,
  mergeOptions,
  defineReactive,
};
//以及
Vue.set = set;
Vue.delete = del;
Vue.nextTick = nextTick;
```

```js
import Vue from './instance/index';
import { initGlobalAPI } from './global-api/index';
import { isServerRendering } from 'core/util/env';
import { FunctionalRenderContext } from 'core/vdom/create-functional-component';

initGlobalAPI(Vue);

Object.defineProperty(Vue.prototype, '$isServer', {
  get: isServerRendering,
});

Object.defineProperty(Vue.prototype, '$ssrContext', {
  get() {
    /* istanbul ignore next */
    return this.$vnode && this.$vnode.ssrContext;
  },
});

// expose FunctionalRenderContext for ssr runtime helper installation
Object.defineProperty(Vue, 'FunctionalRenderContext', {
  value: FunctionalRenderContext,
});

Vue.version = '__VERSION__';

export default Vue;
```

## src/core/instance/index

终于到了最后，最初声明 Vue 的地方，可以看到 Vue 其实就是一个用 `Function` 实现的类，我们只能通过 `new Vue` 去实例化它。至于为什么用 `Function` 而不用 `Class`, 原型链的方式更好扩展，更清晰。分步来给 `Vue` 上 添加需要的方法。并且给这些方法分离开，更好管理。

```js
import { initMixin } from './init';
import { stateMixin } from './state';
import { renderMixin } from './render';
import { eventsMixin } from './events';
import { lifecycleMixin } from './lifecycle';
import { warn } from '../util/index';

function Vue(options) {
  if (
    process.env.NODE_ENV !== 'production' &&
    !(this instanceof Vue) //Vue 必须通过 new 的方式来实例化
  ) {
    warn('Vue is a constructor and should be called with the `new` keyword');
  }
  this._init(options);
}

initMixin(Vue);
stateMixin(Vue);
eventsMixin(Vue);
lifecycleMixin(Vue);
renderMixin(Vue);

export default Vue;
```
