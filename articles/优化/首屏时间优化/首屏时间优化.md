# 首屏时间优化

页面渲染主要分为这三个阶段：客户端发起请求阶段、 服务端数据处理请求阶段、 客户端⻚⾯渲染阶段

## 客户端发起请求阶段

简略点来说：

- 用户输入 url
- 如果是域名，浏览器会通过向 DNS 服务器发起**DNS 查询**，获取 IP
- 浏览器通过 ip 地址找到目标服务器，发起 TCP 三次握手
- 如果是 HTTPS，还有 TLS 协商
- 成功通信，请求数据

在这个过程中，可以优化的点有：本地缓存、DNS 查询、 HTTP 请求

### 本地缓存

浏览器本地缓存有强缓存和协商缓存之分。强缓存通过 expires 和 cache-control 判断是否命中客户端缓存，不会发起请求到服务器。  
 协商缓存，浏览器先发动一个请求到服务器，通过 last-modified（最后修改时间） 和 ETag（文件生成的唯一标识），如果缓存有效，返回 302，此时浏览器取本地缓存，如果失效，服务器返回最新资源

Memory Cache 和 Disk Cache  
 Memory Cache 指的是内存缓存，从效率上讲它是最快的。但是从存活时间来讲又是最短的，当渲染进程结束后，内存缓存也就不存在了。  
 Disk Cache 就是存储在磁盘中的缓存，从存取效率上讲是比内存缓存慢的，但是他的优势在于存储容量和存储时长。

### DNS 查询 （使用 udp 协议）

DNS 的查询过程是，

- 浏览器 DNS 缓存->
- 本机 host 文件->
- 本地 DNS 解析器缓存->
- TCP/ip 参数中设置的首选 DNS 服务器，在此我们叫它本地 DNS 服务器。，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。  
  如果要查询的域名，不由本地 DNS 服务器区域解析，但该服务器已缓存了此网址映射关系，则调用这个 IP 地址映射，完成域名解析，此解析不具有权威性。
- 如果本地 DNS 服务器本地区域文件与缓存解析都失效
  - 非转发模式: 本地 DNS 就把请求发至 13 台根 DNS，根 DNS 服务器收到请求后会判断这个域名(.com)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个 IP。本地 DNS 服务器收到 IP 信息后，将会联系负责.com 域的这台服务器。这台负责.com 域的服务器收到请求后，如果自己无法解析，它就会找一个管理.com 域的下一级 DNS 服务器地址(http://qq.com)给本地 DNS 服务器。
  - 转发模式： 此 DNS 服务器就会把请求转发至上一级 DNS 服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根 DNS 或把转请求转至上上级

可优化点：DNS-prefetch (DNS 预获取) 是尝试在请求资源之前解析域名。这可能是后面要加载的文件，也可能是用户尝试打开的链接目标。

```html
<link rel="dns-prefetch" href="https://fonts.googleapis.com/" />
```

- dns-prefetch 仅对跨域域上的 DNS 查找有效
- 考虑将 dns-prefetch 与 preconnect(预连接)提示配对。尽管 dns-prefetch 仅执行 DNS 查找，但 preconnect 会建立与服务器的连接。如果站点是通过 HTTPS 服务的，则此过程包括 DNS 解析，建立 TCP 连接以及执行 TLS 握手。将两者结合起来可提供进一步减少跨域请求的感知延迟的机会

```html
<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin /> <link rel="dns-prefetch" href="https://fonts.gstatic.com/" />
```

### HTTP 请求

最⼤的瓶颈点来源于请求阻塞。所谓请求阻塞，就是浏览器为保证访问速度， =会默认对同⼀域下的资源保持⼀定的连接数，请求过多就会进⾏阻塞。一般是 6 个链接。

域名分片(Domain sharding) ）会将内容拆分到多个子域中。当使用多个域来处理多个资源时，浏览器能够同时下载更多资源，从而缩短了页面加载时间并改善了用户体验。

就性能而言，域名分片的问题在于每个域都需要额外的 DNS 查找成本以及建立每个 TCP 连接的开销。

HTTP/2 没有限制并发请求（unlimited concurrent requests），因此启用 HTTP/2 后，就没必要再使用域名分片来解决并发限制了。

## 服务端数据处理请求阶段

- 数据缓存：借助 Service Worker 的数据接⼝缓存、 借助本地存储的接⼝缓存和 CDN。
- 数据压缩（Gzip）
- 重定向：  
  是指⽹站资源（如表单， 整个站点等） 迁移到其他位置后， ⽤户访问站点时， 程序⾃动 将⽤户请求从⼀个⻚⾯转移到另外⼀个⻚⾯的过程。 在服务端处理阶段， 重定向分为三类： 服务端发挥的 302 重定向， META 标签实现的重定向和前端 Javasript 通过 window.location 实现的重定向。  
  它们都会引发新的 DNS 查询， 导致新的 TCP 三次握⼿和 TLS 协商， 以及产⽣新的 HTTP 请求

## 客户端⻚⾯渲染阶段

### 构建 DOM 树的瓶颈点

- 是当 HTML 标签不满⾜ Web 语义化时， 浏览器就需要更多时间去解析 DOM 标签的含义
- DOM 节点的数量越多， 构建 DOM 树的时间就会变⻓
- ⽂档中包含\<script> 标签时的情况。  
  外部脚本的加载时机⼀定要确定好， 能够延迟加载就选⽤延迟加载。 另外， 我们可以通过使⽤ defer 和 async， 告诉浏览器在等待脚本下载期间不阻⽌解析过程， 这样做可以明显提升性能
